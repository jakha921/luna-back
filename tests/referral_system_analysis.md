# –ê–Ω–∞–ª–∏–∑ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã Luna Terra Backend

## üìã –û–±–∑–æ—Ä —Å–∏—Å—Ç–µ–º—ã

–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –≤ –ø—Ä–æ–µ–∫—Ç–µ Luna Terra —Ä–∞–±–æ—Ç–∞–µ—Ç —Å–ª–µ–¥—É—é—â–∏–º –æ–±—Ä–∞–∑–æ–º:

### üéØ –û—Å–Ω–æ–≤–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è:
1. **–ö—Ç–æ –ø—Ä–∏–≥–ª–∞—Å–∏–ª** –ø–æ–ª—É—á–∞–µ—Ç $50 –ø–æ –Ω—ã–Ω–µ—à–Ω–µ–º—É –∫—É—Ä—Å—É LUNA
2. **–ü—Ä–∏–≥–ª–∞—à–µ–Ω–Ω–æ–º—É** –∑–∞–≥—Ä–µ–ø–ª—è–µ—Ç—Å—è –∫–æ–¥ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–Ω–æ–≥–æ (–µ–º—É –Ω–µ –Ω–∞—á–∏—Å–ª—è–µ—Ç—Å—è –≤ –±–∞–ª–∞–Ω—Å –Ω–∏—á–µ–≥–æ)

### üîç –¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

#### –ö–æ–¥ –≤ `src/repositories/user.py` (—Å—Ç—Ä–æ–∫–∏ 50-58):
```python
luna_price = get_luna_price_binance()
data["invitation_bonus"] = int(luna_price * 50 * 1000000)
inviter_user = await self.get(id=data["referred_by"])
inviter_user.balance += data["invitation_bonus"]
```

## üêõ –í—ã—è–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### ‚ùå **–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è —Ñ–æ—Ä–º—É–ª–∞ —Ä–∞—Å—á–µ—Ç–∞**

**–¢–µ–∫—É—â–∞—è —Ñ–æ—Ä–º—É–ª–∞:** `int(luna_price * 50 * 1000000)`
**–ü—Ä–∞–≤–∏–ª—å–Ω–∞—è —Ñ–æ—Ä–º—É–ª–∞:** `int((50 / luna_price) * 1000000)`

#### –ü—Ä–∏–º–µ—Ä –ø—Ä–∏ —Ü–µ–Ω–µ LUNA = $0.5:
- **–¢–µ–∫—É—â–∞—è —Ñ–æ—Ä–º—É–ª–∞:** `int(0.5 * 50 * 1000000) = 25,000,000` (25 LUNA)
- **–ü—Ä–∞–≤–∏–ª—å–Ω–∞—è —Ñ–æ—Ä–º—É–ª–∞:** `int((50 / 0.5) * 1000000) = 100,000,000` (100 LUNA)
- **–†–∞–∑–Ω–∏—Ü–∞:** –í 4 —Ä–∞–∑–∞ –º–µ–Ω—å—à–µ –±–æ–Ω—É—Å–∞!

### üìä –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

| –¶–µ–Ω–∞ LUNA | –¢–µ–∫—É—â–∞—è —Ñ–æ—Ä–º—É–ª–∞ | –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è —Ñ–æ—Ä–º—É–ª–∞ | –†–∞–∑–Ω–∏—Ü–∞ |
|-----------|-----------------|-------------------|---------|
| $0.1      | 5,000,000       | 500,000,000       | 100x    |
| $0.5      | 25,000,000      | 100,000,000       | 4x      |
| $1.0      | 50,000,000      | 50,000,000        | 1x      |
| $2.0      | 100,000,000     | 25,000,000        | 0.25x   |

## ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### –¢–µ—Å—Ç—ã –ª–æ–≥–∏–∫–∏ (6/6 PASSED):
- ‚úÖ `test_referral_bonus_calculation` - –†–∞—Å—á–µ—Ç –±–æ–Ω—É—Å–∞
- ‚úÖ `test_referral_system_business_logic` - –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞
- ‚úÖ `test_referral_bonus_formula_analysis` - –ê–Ω–∞–ª–∏–∑ —Ñ–æ—Ä–º—É–ª—ã
- ‚úÖ `test_referral_system_requirements` - –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã
- ‚úÖ `test_current_code_bug` - –í—ã—è–≤–ª–µ–Ω–∏–µ –±–∞–≥–∞
- ‚úÖ `test_referral_system_correct_implementation` - –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

### –¢–µ—Å—Ç—ã —Å–∏—Å—Ç–µ–º—ã (11/11 PASSED):
- ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –±–µ–∑ —Ä–µ—Ñ–µ—Ä–∞–ª–∞
- ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å —Ä–µ—Ñ–µ—Ä–∞–ª–æ–º
- ‚úÖ –†–∞—Å—á–µ—Ç —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–≥–æ –±–æ–Ω—É—Å–∞
- ‚úÖ –†–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–µ —Å–≤—è–∑–∏
- ‚úÖ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã—Ö –∫–æ–¥–æ–≤
- ‚úÖ –ü—Ä–∏–≥–ª–∞—à–µ–Ω–Ω—ã–π –ù–ï –ø–æ–ª—É—á–∞–µ—Ç –±–æ–Ω—É—Å –Ω–∞ –±–∞–ª–∞–Ω—Å
- ‚úÖ –ü—Ä–∏–≥–ª–∞—à–∞—é—â–∏–π –ø–æ–ª—É—á–∞–µ—Ç –±–æ–Ω—É—Å –Ω–∞ –±–∞–ª–∞–Ω—Å
- ‚úÖ –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã
- ‚úÖ –ü–æ–ª–Ω—ã–π —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å
- ‚úÖ –£–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã—Ö –∫–æ–¥–æ–≤
- ‚úÖ –†–µ—Ñ–µ—Ä–∞–ª—ã —Å —Ä–∞–∑–Ω—ã–º–∏ —Ü–µ–Ω–∞–º–∏ LUNA

## üîß –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—é

### 1. –ò—Å–ø—Ä–∞–≤–∏—Ç—å —Ñ–æ—Ä–º—É–ª—É —Ä–∞—Å—á–µ—Ç–∞ –±–æ–Ω—É—Å–∞

**–í —Ñ–∞–π–ª–µ `src/repositories/user.py` —Å—Ç—Ä–æ–∫–∞ 55:**

```python
# –ë–´–õ–û (–ù–ï–ü–†–ê–í–ò–õ–¨–ù–û):
data["invitation_bonus"] = int(luna_price * 50 * 1000000)

# –î–û–õ–ñ–ù–û –ë–´–¢–¨ (–ü–†–ê–í–ò–õ–¨–ù–û):
data["invitation_bonus"] = int((50 / luna_price) * 1000000)
```

### 2. –û–±–Ω–æ–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏

```python
# –ë–´–õ–û:
# calculate the bonus based on the current LUNA price add $ 50 to invited user balance

# –î–û–õ–ñ–ù–û –ë–´–¢–¨:
# calculate the bonus: $50 worth of LUNA at current price
```

### 3. –î–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é

```python
if luna_price <= 0:
    raise ValueError("LUNA price must be positive")
```

## üìà –ë–∏–∑–Ω–µ—Å-–≤–ª–∏—è–Ω–∏–µ

### –¢–µ–∫—É—â–∏–µ –ø–æ—Ç–µ—Ä–∏ –ø—Ä–∏ —Ü–µ–Ω–µ LUNA = $0.5:
- **–î–æ–ª–∂–Ω–æ –±—ã—Ç—å:** 100 LUNA ($50)
- **–§–∞–∫—Ç–∏—á–µ—Å–∫–∏:** 25 LUNA ($12.50)
- **–ü–æ—Ç–µ—Ä–∏:** $37.50 –Ω–∞ –∫–∞–∂–¥–æ–≥–æ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

### –ü—Ä–∏ —Ü–µ–Ω–µ LUNA = $0.1:
- **–î–æ–ª–∂–Ω–æ –±—ã—Ç—å:** 500 LUNA ($50)
- **–§–∞–∫—Ç–∏—á–µ—Å–∫–∏:** 5 LUNA ($0.50)
- **–ü–æ—Ç–µ—Ä–∏:** $49.50 –Ω–∞ –∫–∞–∂–¥–æ–≥–æ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

## üéØ –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ **—Ä–∞–±–æ—Ç–∞–µ—Ç**, –Ω–æ —Å **–∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–π –æ—à–∏–±–∫–æ–π** –≤ —Ä–∞—Å—á–µ—Ç–µ –±–æ–Ω—É—Å–∞. –ü—Ä–∏–≥–ª–∞—à–∞—é—â–∏–µ –ø–æ–ª—É—á–∞—é—Ç –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ –º–µ–Ω—å—à–µ –±–æ–Ω—É—Å–∞, —á–µ–º –¥–æ–ª–∂–Ω—ã –ø–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º.

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô - —Ç—Ä–µ–±—É–µ—Ç –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è.

**–°—Ç–∞—Ç—É—Å —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:** ‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç, –±–∞–≥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω. 